(function(e) {
    var t, n = navigator.userAgent,
        r = /iphone/i.test(n),
        i = /chrome/i.test(n),
        o = /android/i.test(n);
    e.mask = {
        definitions: {
            d: "[0-9]",
            a: "[A-Za-z]",
            "*": "[A-Za-z0-9]"
        },
        autoclear: !0,
        dataName: "rawMaskFn",
        placeholder: "_"
    }, e.fn.extend({
        caret: function(e, t) {
            var n;
            if (0 !== this.length && !this.is(":hidden")) return "number" == typeof e ? (t = "number" == typeof t ? t : e, this.each(function() {
                this.setSelectionRange ? this.setSelectionRange(e, t) : this.createTextRange && ((n = this.createTextRange()).collapse(!0), n.moveEnd("character", t), n.moveStart("character", e), n.select())
            })) : (this[0].setSelectionRange ? (e = this[0].selectionStart, t = this[0].selectionEnd) : document.selection && document.selection.createRange && (n = document.selection.createRange(), e = 0 - n.duplicate().moveStart("character", -1e5), t = e + n.text.length), {
                begin: e,
                end: t
            })
        },
        unmask: function() {
            return this.trigger("unmask")
        },
        mask: function(n, a) {
            var s, u, c, l, f, p, h;
            if (!n && this.length > 0) {
                var d = e(this[0]).data(e.mask.dataName);
                return d ? d() : void 0
            }
            return a = e.extend({
                autoclear: e.mask.autoclear,
                placeholder: e.mask.placeholder,
                completed: null
            }, a), s = e.mask.definitions, u = [], c = p = n.length, l = null, e.each(n.split(""), function(e, t) {
                "?" == t ? (p--, c = e) : s[t] ? (u.push(new RegExp(s[t])), null === l && (l = u.length - 1), c > e && (f = u.length - 1)) : u.push(null)
            }), this.trigger("unmask").each(function() {
                function d() {
                    if (a.completed) {
                        for (var e = l; f >= e; e++)
                            if (u[e] && C[e] === v(e)) return;
                        a.completed.call(x)
                    }
                }

                function v(e) {
                    return a.placeholder.charAt(e < a.placeholder.length ? e : 0)
                }

                function g(e) {
                    for (; ++e < p && !u[e];);
                    return e
                }

                function m(e, t) {
                    var n, r;
                    if (!(0 > e)) {
                        for (n = e, r = g(t); p > n; n++)
                            if (u[n]) {
                                if (!(p > r && u[n].test(C[r]))) break;
                                C[n] = C[r], C[r] = v(r), r = g(r)
                            } w(), x.caret(Math.max(l, e))
                    }
                }

                function $() {
                    b(), x.val() != k && x.change()
                }

                function y(e, t) {
                    var n;
                    for (n = e; t > n && p > n; n++) u[n] && (C[n] = v(n))
                }

                function w() {
                    x.val(C.join(""))
                }

                function b(e) {
                    var t, n, r, i = x.val(),
                        o = -1;
                    for (t = 0, r = 0; p > t; t++)
                        if (u[t]) {
                            for (C[t] = v(t); r++ < i.length;)
                                if (n = i.charAt(r - 1), u[t].test(n)) {
                                    C[t] = n, o = t;
                                    break
                                } if (r > i.length) {
                                y(t + 1, p);
                                break
                            }
                        } else C[t] === i.charAt(r) && r++, c > t && (o = t);
                    return e ? w() : c > o + 1 ? a.autoclear || C.join("") === S ? (x.val() && x.val(""), y(0, p)) : w() : (w(), x.val(x.val().substring(0, o + 1))), c ? t : l
                }
                var x = e(this),
                    C = e.map(n.split(""), function(e, t) {
                        return "?" != e ? s[e] ? v(t) : e : void 0
                    }),
                    S = C.join(""),
                    k = x.val();
                x.data(e.mask.dataName, function() {
                    return e.map(C, function(e, t) {
                        return u[t] && e != v(t) ? e : null
                    }).join("")
                }), x.one("unmask", function() {
                    x.off(".mask").removeData(e.mask.dataName)
                }).on("focus.mask", function() {
                    var e;
                    x.prop("readonly") || (clearTimeout(t), k = x.val(), e = b(), t = setTimeout(function() {
                        x.get(0) === document.activeElement && (w(), e == n.replace("?", "").length ? x.caret(0, e) : x.caret(e))
                    }, 10))
                }).on("blur.mask", $).on("keydown.mask", function(e) {
                    if (!x.prop("readonly")) {
                        var t, n, i, o = e.which || e.keyCode;
                        h = x.val(), 8 === o || 46 === o || r && 127 === o ? (n = (t = x.caret()).begin, (i = t.end) - n == 0 && (n = 46 !== o ? function(e) {
                            for (; --e >= 0 && !u[e];);
                            return e
                        }(n) : i = g(n - 1), i = 46 === o ? g(i) : i), y(n, i), m(n, i - 1), e.preventDefault()) : 13 === o ? $.call(this, e) : 27 === o && (x.val(k), x.caret(0, b()), e.preventDefault())
                    }
                }).on("keypress.mask", function(t) {
                    if (!x.prop("readonly")) {
                        var n, r, i, a = t.which || t.keyCode,
                            s = x.caret();
                        t.ctrlKey || t.altKey || t.metaKey || 32 > a || !a || 13 === a || (s.end - s.begin != 0 && (y(s.begin, s.end), m(s.begin, s.end - 1)), n = g(s.begin - 1), p > n && (r = String.fromCharCode(a), u[n].test(r)) && (function(e) {
                            var t, n, r, i;
                            for (t = e, n = v(e); p > t; t++)
                                if (u[t]) {
                                    if (r = g(t), i = C[t], C[t] = n, !(p > r && u[r].test(i))) break;
                                    n = i
                                }
                        }(n), C[n] = r, w(), i = g(n), o ? setTimeout(function() {
                            e.proxy(e.fn.caret, x, i)()
                        }, 0) : x.caret(i), s.begin <= f && d()), t.preventDefault())
                    }
                }).on("input.mask paste.mask", function() {
                    x.prop("readonly") || setTimeout(function() {
                        var e = b(!0);
                        x.caret(e), d()
                    }, 0)
                }), i && o && x.off("input.mask").on("input.mask", function() {
                    var e = x.val(),
                        t = x.caret();
                    if (h && h.length && h.length > e.length) {
                        for (b(!0); t.begin > 0 && !u[t.begin - 1];) t.begin--;
                        if (0 === t.begin)
                            for (; t.begin < l && !u[t.begin];) t.begin++;
                        x.caret(t.begin, t.begin)
                    } else {
                        for (b(!0); t.begin < p && !u[t.begin];) t.begin++;
                        x.caret(t.begin, t.begin)
                    }
                    d()
                }), b()
            })
        }
    })
})(jQuery);